from flask import Flask, render_template, request, session, redirect, url_for
from mmpi_logic import MMPIEngine

app = Flask(__name__)
app.secret_key = 'MMPI_SECRET_KEY_SECURE_V2'

QUESTIONS_DATA = [
    [1, "اشتهای خوبی دارم. ", [[0, "بله"], [1, "خیر"]]],
    [2, "بیشتر صبح‌ها خوش و سرحال از خواب برمی‌خیزم. ", [[0, "بله"], [1, "خیر"]]],
    [3, "زندگی روزانه‌ی من پر از چیز‌هایی است که برایم جالب هستند. ", [[0, "بله"], [1, "خیر"]]],
    [4, "موقع کار فشار و ناراحتی زیادی احساس می‌کنم ", [[0, "بله"], [1, "خیر"]]],
    [5, "گاهی فکر‌های بدی می‌کنم که نمی‌شود ‌‌درباره‌ی آن صحبت کرد. ", [[0, "بله"], [1, "خیر"]]],
    [6, "و به ندرت دچار یبوست می‌شوم یا اصلا نمی‌شوم.", [[0, "بله"], [1, "خیر"]]],
    [7, "بعضی وقت‌ها دلم می‌خواهد خانواده‌‌ام را ترک کنم.", [[0, "بله"], [1, "خیر"]]],
    [8, "گاهی اوقات آن چنان به گریه یا خنده می‌افتم که نمی‌توانم جلوی آن را بگیرم.", [[0, "بله"], [1, "خیر"]]],
    [9, "هر چند وقت یک بار تهوع و استفراغ ناراحتم می‌کند. ", [[0, "بله"], [1, "خیر"]]],
    [10, "به نظرم هیچ کس مرا درک نمی‌کند. ", [[0, "بله"], [1, "خیر"]]],
    [11, "گاهی دلم می‌خواهد ناسزا بگویم. ", [[0, "بله"], [1, "خیر"]]],
    [12, "هر چند شب یک بار دچار کابوس می‌شوم خواب‌های وحشتناک می‌بینم.", [[0, "بله"], [1, "خیر"]]],
    [13, "برایم مشکل است که حواسم را روی کاری متمرکز کنم. ", [[0, "بله"], [1, "خیر"]]],
    [14, "من تجربه‌های مخصوص و عجیبی داشته‌‌ام. ", [[0, "بله"], [1, "خیر"]]],
    [15, "اگر دیگران برایم نزده بودند، پشت سرم بدگویی نکرده بودند، من بیشتر موفق بودم.", [[0, "بله"], [1, "خیر"]]],
    [16, "در دوران جوانی مرتکب سرقت‌های جزئی شده‌‌ام. ", [[0, "بله"], [1, "خیر"]]],
    [17, "گاه گاه روز‌ها، هفته‌ها، و حتی ماه‌ها بوده که دست و دلم به کاری نرفته است. ", [[0, "بله"], [1, "خیر"]]],
    [18, "خوابم آشفته است. ", [[0, "بله"], [1, "خیر"]]],
    [19, "با دیگران که هستم تحمل شنیدن حرف‌های عجیب و غریب آن‌ها را ندارم.", [[0, "بله"], [1, "خیر"]]],
    [20, "اکثر کسانی که مرا می‌شناسند از من خوششان می‌آید. ", [[0, "بله"], [1, "خیر"]]],
    [21, "ای کاش به اندازه‌ی دیگران خوشحال بودم. ", [[0, "بله"], [1, "خیر"]]],
    [22, "اغلب مجبور بوده‌‌ام از کسانی اطاعت کنم که به اندازه‌ی من نمی‌فهمیدند. ", [[0, "بله"], [1, "خیر"]]],
    [23, "فکر می‌کنم بسیاری از مردم برای جلب کمک و همدردی دیگران بدبختی‌های خود را بزرگتر جلوه می‌دهند.", [[0, "بله"], [1, "خیر"]]],
    [24, "بعضی وقت‌ها خشمگین می‌شوم. ", [[0, "بله"], [1, "خیر"]]],
    [25, "واقعاً اعتماد به نفس ندارم. ", [[0, "بله"], [1, "خیر"]]],
    [26, "خیلی کم از پرش و تکان ماهیچه‌هایم ناراحت می‌شوم یا اصلاً دچار پرش و تکان ماهیچه‌ها نمی‌شوم.", [[0, "بله"], [1, "خیر"]]],
    [27, "خیلی وقت‌ها احساس می‌کنم که مرتکب کار زشت یا خطایی شده‌‌ام. ", [[0, "بله"], [1, "خیر"]]],
    [28, "بیشتر اوقات خوشحالم. ", [[0, "بله"], [1, "خیر"]]],
    [29, "بعضی اشخاص آن قدر تحکم می‌کنند که حتی وقتی می‌دانم که حق با آن‌ها است دلم می‌خواهد بر خلاف آن چه می‌خواهند رفتار کنم.", [[0, "بله"], [1, "خیر"]]],
    [30, "معتقدم بر ضد من توطئه چینی می‌شود. ", [[0, "بله"], [1, "خیر"]]],
    [31, "اغلب مردم حاضرند حتی با شیوه‌های غیر عادلانه به منافع و مزایایی برسند. ", [[0, "بله"], [1, "خیر"]]],
    [32, "معده‌‌ام خیلی ناراحتم می‌کند. ", [[0, "بله"], [1, "خیر"]]],
    [33, "اغلب نمی‌فهمم چرا آن قدر بد خلق و بد قلق بوده‌‌ام. ", [[0, "بله"], [1, "خیر"]]],
    [34, "بعضی اوقات افکارم سریع‌تر از آن بوده که بتوانم به زبان بیاورم. ", [[0, "بله"], [1, "خیر"]]],
    [35, "فکر می‌کنم که زندگی خانوادگی‌‌ام به خوبی زندگی اغلب کسانی است که می‌شناسم. ", [[0, "بله"], [1, "خیر"]]],
    [36, "گاهی وقت‌ها احساس می‌کنم که واقعاً آدم بی مصرفی هستم. ", [[0, "بله"], [1, "خیر"]]],
    [37, "در چند سال اخیر بیشتر اوقات حالم خوب بوده است. ", [[0, "بله"], [1, "خیر"]]],
    [38, "در زندگی من مواقعی بوده است که در آن دست به کار‌هایی زده‌‌ام که بعد‌ها نمی‌دانستم چه بوده است.", [[0, "بله"], [1, "خیر"]]],
    [39, "احساس می‌کنم که غالباً بی‌دلیل مجازات شده‌‌ام. ", [[0, "بله"], [1, "خیر"]]],
    [40, "هیچ وقت حالم بهتر از حالا نبوده است. ", [[0, "بله"], [1, "خیر"]]],
    [41, "برایم مهم نیست که دیگران ‌‌درباره‌ی من چه فکر می‌کنند. ", [[0, "بله"], [1, "خیر"]]],
    [42, "حافظه‌‌ام خوب است. ", [[0, "بله"], [1, "خیر"]]],
    [43, "گفتگو با غریبه‌ها برایم دشوار است. ", [[0, "بله"], [1, "خیر"]]],
    [44, "اغلب سر تا پا احساس ضعف می‌کنم.", [[0, "بله"], [1, "خیر"]]],
    [45, "به ندرت دچار سردرد می‌شوم یا اصلاً دچار سردرد نمی‌شوم. ", [[0, "بله"], [1, "خیر"]]],
    [46, "تا به حال اشکالی در حفظ تعادل خود موقع راه رفتن نداشته‌‌ام.", [[0, "بله"], [1, "خیر"]]],
    [47, "بین کسانی که می‌شناسم بعضی‌ها را دوست ندارم. ", [[0, "بله"], [1, "خیر"]]],
    [48, "کسانی هستند که سعی دارند افکار و عقاید مرا بدزدند. ", [[0, "بله"], [1, "خیر"]]],
    [49, "کاش این قدر خجالتی نبودم. ", [[0, "بله"], [1, "خیر"]]], 
    [50, "معتقدم که گنا‌هانم غیرقابل بخشش هستند. ", [[0, "بله"], [1, "خیر"]]],
    [51, "غالباً از چیزی دلواپسم.", [[0, "بله"], [1, "خیر"]]],
    [52, "رفقایم غالباً مورد پسند مادر و پدرم نبوده‌اند. ", [[0, "بله"], [1, "خیر"]]],
    [53, "کمی‌پشت سر دیگران غیبت می‌کنم.", [[0, "بله"], [1, "خیر"]]],
    [54, "بعضی وقت‌ها احساس می‌کنم که خیلی آسان تصمیم می‌گیرم.", [[0, "بله"], [1, "خیر"]]],
    [55, "تقریباً هیچ وقت تپش قلب یا تنگی نفس نداشته‌‌ام. ", [[0, "بله"], [1, "خیر"]]],
    [56, "زود از کوره در می‌روم و زود آرام می‌گیرم. ", [[0, "بله"], [1, "خیر"]]],
    [57, "بعضی وقت‌ها آن قدر بی قرار بوده‌‌ام که نمی‌توانستم یک جا بند شوم. ", [[0, "بله"], [1, "خیر"]]],
    [58, "والدین و اعضای خانواده‌‌ام بیش از حد از من ایراد می‌گیرند. ", [[0, "بله"], [1, "خیر"]]],
    [59, "برای هیچ کس چندان مهم نیست چه به سرم می‌آید. ", [[0, "بله"], [1, "خیر"]]],
    [60, "سوء استفاده از کسی که خود چنین‌‌امکانی را می‌دهد را بد نمی‌دانم.", [[0, "بله"], [1, "خیر"]]],
    [61, "گاهی اوقات احساس می‌کنم سرشار از انرژی هستم.", [[0, "بله"], [1, "خیر"]]],
    [62, "قدرت بینایی من به خوبی سال‌های قبل است. ", [[0, "بله"], [1, "خیر"]]],
    [63, "خیلی کم متوجه شده‌‌ام که گوشم زنگ بزند یا وزوز کند. ", [[0, "بله"], [1, "خیر"]]],
    [64, "یکی دو بار در زندگی احساس کرده‌‌ام که کسی سعی دارد با تلقین و هیپنوتیزم مرا وادار به انجام کارهایی بکنند.", [[0, "بله"], [1, "خیر"]]],
    [65, "مواقعی بوده است که بدون علت خاص و بر خلاف معمول با نشاط بوده‌‌ام. ", [[0, "بله"], [1, "خیر"]]],
    [66, "حتی وقتی با دیگرانم غالباً احساس تنهایی می‌کنم. ", [[0, "بله"], [1, "خیر"]]],
    [67, "فکر می‌کنم تقریباً هر کس برای این که به دردسر نیفتد دروغ خواهد گفت. ", [[0, "بله"], [1, "خیر"]]],
    [68, "من حساس‌تر از دیگران هستم.", [[0, "بله"], [1, "خیر"]]],
    [69, "مواقعی است که مغزم کندتر از حد معمول کار می‌کند. ", [[0, "بله"], [1, "خیر"]]],
    [70, "غالباً مردم مرا ناامید می‌کنند. ", [[0, "بله"], [1, "خیر"]]],
    [71, "در خوش گذرانی‌ها افراط کرده‌‌ام.", [[0, "بله"], [1, "خیر"]]]
]

FINAL_QUESTIONS = [item[1] for item in QUESTIONS_DATA]

@app.route('/', methods=['GET', 'POST'])
def index():
    if request.method == 'POST':
        try:
            age_str = request.form.get('age')
            if not age_str:
                return render_template('form.html', questions=FINAL_QUESTIONS, error="لطفا سن خود را وارد کنید.")
            
            age = int(age_str)
            gender = request.form.get('gender')
            
            answers = []
            for i in range(1, 72):
                ans = request.form.get(f'q{i}')
                if ans is None:
                    return render_template('form.html', questions=FINAL_QUESTIONS, error=f"لطفا به سوال شماره {i} پاسخ دهید.")
                
                answers.append(0 if ans == 'yes' else 1)
            
            engine = MMPIEngine(age=age, gender=gender, answers=answers)
            result = engine.process()
            
            record_dummy = {'test': {'desc': 'نتیجه آزمون شخصیت چندوجهی مینه‌سوتا (MMPI) نسخه ۷۱ سوالی'}}
            
            return render_template('result.html', 
                                   result=result, 
                                   is_valid=result.get('is_valid', True),
                                   record=record_dummy)
                                   
        except ValueError:
            return render_template('form.html', questions=FINAL_QUESTIONS, error="فرمت سن نامعتبر است.")
            
    return render_template('form.html', questions=FINAL_QUESTIONS)

if __name__ == '__main__':
    app.run(debug=True)
